<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluation Page</title>
    <link rel="stylesheet" href="../static/css/styleevaluation.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <style>
        .reference-link {
            cursor: pointer;
            color: blue;
            text-decoration: underline;
        }
        .reference-link:hover {
            color: darkblue;
        }
        .shap-section img {
            max-width: 100%;
            border: 1px solid #ccc;
        }
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        .again {
            display: inline-block;
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            color: white;
            background-color: blue;
            text-decoration: none;
            border-radius: 5px;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        .again:hover {
            background-color: darkblue;
        }
    </style>
</head>
<body>
    <div class="colored-box"></div>
    <nav>
        <div class="logo">
            <a href="#">OPG-SHAP</a>
        </div>
        <ul class="menu">
            <li><a href="{{ url_for('index') }}">IMPORT OPG</a></li>
            <li><a href="{{ url_for('evaluationpage') }}" style="color: blue;">EVALUATION</a></li>
        </ul>
    </nav>
    <div class="horizontal-line"></div>
    <div class="content">
        <h2 style="text-align: center; color: blue;">Predict: {{ predict1 }}</h2>
        <h3 style="text-align: center;">Predict Result: <strong>{{ predictresult }}</strong></h3>

        <div class="shap-section" style="display: flex; justify-content: space-around; align-items: center;">
            <div class="shap-negative">
                <h3 style="color: blue; text-align: center;">Negative Values: {{ negative_label }}</h3>
                <img id="negative-image" 
                     src="{{ iou_image_plot_neg_url }}" 
                     alt="Negative SHAP Image"
                     onerror="this.onerror=null; this.src='../static/uploads/iou/iou_no_bbox_neg.png';">
            </div>
            <div class="shap-positive">
                <h3 style="color: red; text-align: center;">Positive Values: {{ positive_label }}</h3>
                <img id="positive-image" 
                     src="{{ iou_image_plot_pos_url }}" 
                     alt="Positive SHAP Image"
                     onerror="this.onerror=null; this.src='../static/uploads/iou/iou_no_bbox_pos.png';">
            </div>
        </div>

        <div class="langchain-results">
            <h3 style="text-align: center;">References Generated By Gemini</h3>
            <div id="reference-container">
                {% for name, result in document_query_result.items() %}
                <div class="result-box">
                    <h4 class="reference-link" onclick="updateImages('{{ name }}')">{{ name }}</h4>
                    <p>{{ result }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="button-container">
        <a class="again" id="download-result" href="javascript:void(0);">Download Result</a>
        <a class="again" id="reset-images" href="javascript:void(0);">Reset Images</a>
        <a class="again" href="{{ url_for('index') }}">Predict Again</a>
    </div>

    <script>
        // Map class names to their respective split image filenames
        const imageMappings = {};
        {% for name in document_query_result.keys() %}
            imageMappings["{{ name }}"] = {
                positive: "iou_single_bbox_pos_{{ name }}.png",
                negative: "iou_single_bbox_neg_{{ name }}.png"
            };
        {% endfor %}

        // Paths to the default evaluation images
        const defaultPositiveImage = "{{ iou_image_plot_pos_url }}";
        const defaultNegativeImage = "{{ iou_image_plot_neg_url }}";

        // Paths to the no-bbox placeholder images
        const noBboxPositiveImage = "../static/uploads/iou/iou_no_bbox_pos.png";
        const noBboxNegativeImage = "../static/uploads/iou/iou_no_bbox_neg.png";

        // Function to update both positive and negative images when a reference is clicked
        function updateImages(className) {
            const positiveImage = imageMappings[className]?.positive;
            const negativeImage = imageMappings[className]?.negative;

            const positivePath = positiveImage
                ? `../static/uploads/iou/${positiveImage}`
                : noBboxPositiveImage; // Fallback to no-bbox image if no specific positive image
            const negativePath = negativeImage
                ? `../static/uploads/iou/${negativeImage}`
                : noBboxNegativeImage; // Fallback to no-bbox image if no specific negative image

            // Update the image sources with a unique timestamp to avoid caching
            const timestamp = new Date().getTime();
            document.getElementById('positive-image').src = `${positivePath}?t=${timestamp}`;
            document.getElementById('negative-image').src = `${negativePath}?t=${timestamp}`;
        }

        // Function to reset images to their default sources
        function resetImages() {
            document.getElementById('positive-image').src = defaultPositiveImage;
            document.getElementById('negative-image').src = defaultNegativeImage;

            // Reapply onerror handlers for fallback logic
            document.getElementById('positive-image').onerror = function () {
                this.onerror = null;
                this.src = noBboxPositiveImage;
            };
            document.getElementById('negative-image').onerror = function () {
                this.onerror = null;
                this.src = noBboxNegativeImage;
            };
        }

        // Add event listener for reset button
        document.getElementById('reset-images').addEventListener('click', resetImages);

        // Function to download the page as a PDF
        document.getElementById('download-result').addEventListener('click', function () {
            var element = document.body;
            var opt = {
                margin: 1,
                filename: 'evaluation_result.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().from(element).set(opt).save();
        });
    </script>
</body>
</html>
