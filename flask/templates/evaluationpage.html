<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPG - SHAP WEB</title>
    <link rel="stylesheet" href="../static/css/styleevaluation.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="colored-box"></div>
    <nav>
        <div class="logo">
            <a href="#">OPG-SHAP</a>
        </div>
        <ul class="menu">
            <li><a href="{{ url_for('index') }}">IMPORT MODELS</a></li>
            <li><a href="{{ url_for('go2') }}">SHAP</a></li>
            <li><a href="{{ url_for('shappercentile_page') }}">SHAP-PERCENTILE</a></li>
            <li><a href="{{ url_for('evaluationpage') }}" style="color: blue;">EVALUATION</a></li>
        </ul>
    </nav>
    <div class="horizontal-line"></div>
    <div class="back-button"></div>
    <div id="result-content">                    
        <h2>EVALUATION</h2>
        <label for="value_iou">IOU</label>
        <input type="number" name="value_iou" id="value_iou" min="0" max="100" step="1" value="10">
        <form onsubmit="event.preventDefault(); sendRangeValues();">    
            <button id="submit_value_iou" type="submit">Update</button>
        </form>
        <p>Predict: <span id="predict1">{{ predict1 }}</span></p>
        <p>Predict result: <span id="predictresult">{{ predictresult }}</span></p>
        <div class="container">
            <div class="shapneg">
                <p class="negative-text">Negative values: <span id="node0_1">{{ node0_1 }}</span></p>
                <img id="iou_image_plot_neg" src="{{ iou_image_plot_neg_url }}" alt="#" class="image">
                <div class="table-container tab_neg">
                    {% for table in tables_descript_neg %} 
                        {{ table|safe }}
                    {% endfor %}
                </div>
            </div>
            <div class="shappos">
                <p class="positive-text">Positive values: <span id="node1_1">{{ node1_1 }}</span></p>
                <img id="iou_image_plot_pos" src="{{ iou_image_plot_pos_url }}" alt="#" class="image">
                <div class="table-container tab_pos">
                    {% for table in tables_descript_pos %}
                        {{ table|safe }}
                    {% endfor %}
                </div>
            </div>
        </div>
        <div id="query-result">
            <h3>References Generated by Google Gemini:</h3>
            <div id="reference-container">
                {% for name, result in document_query_result.items() %}
                <div class="result-box">
                    <h4>{{ name }}</h4>
                    <p>{{ result }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="button-container">
        <button id="download-result">Download Result</button>
        <a class="again" href="{{ url_for('index') }}">Predict Again</a>
    </div>

    <!-- JavaScript code -->
    <script>
        function reloadImages() {
            var negImgElement = document.getElementById('iou_image_plot_neg');
            var posImgElement = document.getElementById('iou_image_plot_pos');
            var timestamp = new Date().getTime(); // Get current timestamp
            negImgElement.src = '{{ iou_image_plot_neg_url }}?' + timestamp; // Append timestamp to avoid caching
            posImgElement.src = '{{ iou_image_plot_pos_url }}?' + timestamp; // Append timestamp to avoid caching
        }

        function sendRangeValues() {
            const value_iou = document.getElementById("value_iou").value;
            console.log("Value_IOU: " + value_iou);
            fetch("/evaluation", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ value_iou: value_iou })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                reloadTables(data);
                console.log('Success:', data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function reloadTables(data) {
            const tabNeg = document.querySelector('.table-container.tab_neg');
            const tabPos = document.querySelector('.table-container.tab_pos');

            tabNeg.innerHTML = data.tables_descript_neg;
            tabPos.innerHTML = data.tables_descript_pos;

            // Update the query result
            const referenceContainer = document.getElementById('reference-container');
            referenceContainer.innerHTML = '';

            console.log('Document Query Results:', data.document_query_result); // Debugging line

            for (const [name, result] of Object.entries(data.document_query_result)) {
                console.log('Name:', name, 'Result:', result); // Debugging line

                const resultBox = document.createElement('div');
                resultBox.className = 'result-box';

                const resultTitle = document.createElement('h4');
                resultTitle.textContent = name;

                const resultContent = document.createElement('p');
                resultContent.textContent = result;

                resultBox.appendChild(resultTitle);
                resultBox.appendChild(resultContent);
                referenceContainer.appendChild(resultBox);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const value_iou = document.getElementById('value_iou');
            value_iou.addEventListener('input', function() {
                value_iou.textContent = value_iou.value;
            });

            value_iou.addEventListener('change', sendRangeValues);

            // Initial load
            sendRangeValues();
            reloadImages();
            setInterval(reloadImages, 1000);
        });

        document.getElementById('download-result').addEventListener('click', function () {
            var element = document.getElementById('result-content');
            var opt = {
                margin:       1,
                filename:     'result.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            // New Promise-based usage:
            html2pdf().from(element).set(opt).save();
        });
    </script>
</body>
</html>
